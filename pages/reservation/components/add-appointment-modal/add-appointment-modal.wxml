<view class="modal-container" wx:if="{{showModal}}">
    <view class="modal-mask" bindtap="handleCancel"></view>

    <view class="modal-content">
        <!-- æ ‡é¢˜æ  -->
        <view class="modal-header">
            <text class="modal-title">{{isEdit ? 'ç¼–è¾‘é¢„çº¦' : 'æ–°å¢é¢„çº¦'}}</text>
            <text class="close-btn" bindtap="handleCancel">Ã—</text>
        </view>

        <scroll-view class="modal-body" scroll-y style="max-height: {{scrollViewHeight}}px">

            <!-- å®¢æˆ·æœç´¢æ¡† -->
            <view class="customer-search-box">
                <view class="search-input-container">
                    <input class="search-input" placeholder="è¾“å…¥å®¢æˆ·å§“åæˆ–æ‰‹æœºå·æœç´¢" placeholder-style="color: #999;"
                        value="{{searchCustomerKeyword}}" bindinput="onCustomerSearchInput"
                        bindconfirm="onCustomerSearchConfirm" />
                    <text class="search-icon" bindtap="onCustomerSearch">ğŸ”</text>
                </view>

                <!-- æœç´¢ç»“æœåˆ—è¡¨ -->
                <view class="search-results" wx:if="{{showCustomerResults && searchCustomerResults.length > 0}}">
                    <view class="result-item" wx:for="{{searchCustomerResults}}" wx:key="id" bindtap="selectCustomer"
                        data-index="{{index}}" data-id="{{item.id}}">
                        <view class="customer-info">
                            <text class="customer-name">{{item.khxm}}</text>
                            <text class="customer-phone">{{item.khsjh}}</text>
                        </view>
                        <text class="select-hint">é€‰æ‹©</text>
                    </view>
                </view>

                <!-- æœç´¢ç»“æœä¸ºç©ºæç¤º -->
                <view class="no-results"
                    wx:if="{{showCustomerResults && searchCustomerResults.length === 0 && searchCustomerKeyword}}">
                    <text class="no-results-text">æœªæ‰¾åˆ°åŒ¹é…çš„å®¢æˆ·</text>
                </view>
                <!-- å·²é€‰æ‹©çš„å®¢æˆ·ä¿¡æ¯ -->
                <view class="selected-customer" wx:if="{{formData.name || formData.phone}}">
                    <view class="selected-customer-row">
                        <view class="selected-customer-info">
                            <text class="info-label">å®¢æˆ·å§“åï¼š</text>
                            <text class="info-value">{{formData.name}}</text>
                        </view>
                        <view class="selected-customer-info">
                            <text class="info-label">æ‰‹æœºå·ï¼š</text>
                            <text class="info-value">{{formData.phone}}</text>
                        </view>
                    </view>
                    <button class="btn-change-customer" bindtap="clearSelectedCustomer">é‡æ–°é€‰æ‹©</button>
                </view>

                <!-- æ‰‹åŠ¨è¾“å…¥å®¢æˆ·ä¿¡æ¯ï¼ˆå½“æ²¡æœ‰é€‰æ‹©å®¢æˆ·æ—¶æ˜¾ç¤ºï¼‰ -->
                <view wx:if="{{!formData.name && !formData.phone}}">
                    <view class="form-item">
                        <text class="form-label required">å®¢æˆ·å§“å</text>
                        <input class="form-input" type="text" placeholder="è¯·è¾“å…¥å®¢æˆ·å§“å" value="{{formData.name}}"
                            bindinput="onInputChange" data-field="name" maxlength="20" />
                    </view>

                    <view class="form-item">
                        <text class="form-label required">æ‰‹æœºå·</text>
                        <input class="form-input" type="number" placeholder="è¯·è¾“å…¥æ‰‹æœºå·" value="{{formData.phone}}"
                            bindinput="onInputChange" data-field="phone" maxlength="11" />
                    </view>
                </view>


            </view>

            <!-- é¢„çº¦ä¿¡æ¯ -->
            <view class="form-section">
                <view class="section-title">é¢„çº¦ä¿¡æ¯</view>

                <view class="form-item">
                    <text class="form-label required">é¢„çº¦æ—¥æœŸ</text>
                    <picker mode="date" value="{{formData.appointmentDate}}" bindchange="onDateChange"
                        class="picker-input">
                        <view class="picker-text {{formData.appointmentDate ? '' : 'placeholder'}}">
                            {{formData.appointmentDate || 'è¯·é€‰æ‹©é¢„çº¦æ—¥æœŸ'}}
                        </view>
                    </picker>
                </view>

                <view class="form-item">
                    <text class="form-label required">é¢„çº¦æ—¶é—´</text>
                    <picker mode="time" value="{{formData.appointmentTime}}" bindchange="onTimeChange"
                        class="picker-input">
                        <view class="picker-text {{formData.appointmentTime ? '' : 'placeholder'}}">
                            {{formData.appointmentTime || 'è¯·é€‰æ‹©é¢„çº¦æ—¶é—´'}}
                        </view>
                    </picker>
                </view>

                <view class="form-item">
                    <text class="form-label required">æœåŠ¡æ—¶é•¿</text>
                    <picker range="{{durationOptions}}" range-key="name" value="{{durationIndex}}"
                        bindchange="onDurationChange" class="picker-input">
                        <view class="picker-text {{formData.duration ? '' : 'placeholder'}}">
                            {{formData.duration ? formData.duration + 'åˆ†é’Ÿ' : 'è¯·é€‰æ‹©æœåŠ¡æ—¶é•¿'}}
                        </view>
                    </picker>
                </view>
            </view>

            <!-- æœåŠ¡å†…å®¹ -->
            <view class="form-section">
                <view class="section-title">æœåŠ¡å†…å®¹</view>

                <view class="form-item">
                    <text class="form-label required">æœåŠ¡é¡¹ç›®</text>
                    <picker mode="selector" range="{{serviceOptions}}" range-key="name" value="{{serviceIndex}}"
                        bindchange="onServiceChange" class="picker-input">
                        <view class="picker-text {{formData.service ? '' : 'placeholder'}}">
                            {{formData.service || 'è¯·é€‰æ‹©æœåŠ¡é¡¹ç›®'}}
                        </view>
                    </picker>
                </view>

                <view class="form-item">
                    <text class="form-label required">æœåŠ¡äººå‘˜</text>
                    <picker mode="selector" range="{{staffOptions}}" range-key="name" value="{{staffIndex}}"
                        bindchange="onStaffChange" class="picker-input" disabled="{{currentUser.level < 3}}">
                        <view class="picker-text {{formData.staffName ? '' : 'placeholder'}}">
                            {{formData.staffName || (currentUser.level >=3 ? 'è¯·é€‰æ‹©æœåŠ¡äººå‘˜' : currentUser.nickname)}}
                        </view>
                    </picker>
                    <text class="help-text" wx:if="{{currentUser.level <3 }}">æ‚¨åªèƒ½ä¸ºè‡ªå·±é¢„çº¦</text>
                </view>
            </view>

            <!-- å¤‡æ³¨ä¿¡æ¯ -->
            <view class="form-section">
                <view class="section-title">å¤‡æ³¨ä¿¡æ¯</view>

                <view class="form-item">
                    <text class="form-label">é¢„çº¦å¤‡æ³¨</text>
                    <textarea class="form-textarea" placeholder="è¯·è¾“å…¥å¤‡æ³¨ä¿¡æ¯ï¼ˆæœ€å¤š200å­—ï¼‰" value="{{formData.notes}}"
                        bindinput="onTextareaChange" data-field="notes" maxlength="200" />
                    <view class="textarea-counter">
                        <text>{{formData.notes ? formData.notes.length : 0}}/200</text>
                    </view>
                </view>
            </view>
        </scroll-view>

        <!-- åº•éƒ¨æŒ‰é’® -->
        <view class="modal-footer">
            <button class="btn-cancel" bindtap="handleCancel">å–æ¶ˆ</button>
            <button class="btn-confirm" bindtap="handleConfirm" disabled="{{!isFormValid}}">ç¡®è®¤é¢„çº¦</button>
        </view>
    </view>
</view>