<view class="inventory-page">
    <!-- æœç´¢åŒºåŸŸ -->
    <view class="search-bar">
        <!-- å·¦ä¾§ï¼šé—¨åº—é€‰æ‹©å™¨ -->
        <view class="store-picker-container">
            <picker mode="selector" range="{{storeOptions}}" value="{{selectedStoreName}}" bindchange="onStoreChange"
                class="store-picker">
                <view class="store-picker-box">
                    <text class="store-icon">ğŸª</text>
                    <text class="store-text">{{selectedStoreName || 'å…¨éƒ¨é—¨åº—'}}</text>
                    <text class="dropdown-icon">â–¼</text>
                </view>
            </picker>
        </view>

        <!-- å³ä¾§ï¼šæœç´¢æ¡† -->
        <view class="search-input-container">
            <input class="search-input" placeholder="è¾“å…¥å•†å“åç§°æœç´¢" placeholder-style="color: #999;"
                value="{{searchKeyword}}" bindinput="onSearchInput" bindconfirm="onSearchConfirm" />
            <text class="search-icon" bindtap="onSearchConfirm">ğŸ”</text>
        </view>
    </view>

    <!-- åº“å­˜åˆ—è¡¨ -->
    <view class="inventory-list">
        <view wx:if="{{inventoryList.length > 0}}">
            <!-- ç»Ÿè®¡ä¿¡æ¯ -->
            <view class="stats-info">
                <view class="stats-item">
                    <text class="stats-number">{{totalCount}}</text>
                    <text class="stats-label">å•†å“ç§ç±»</text>
                </view>
                <view class="stats-item">
                    <text class="stats-number">{{lowStockCount}}</text>
                    <text class="stats-label">åº“å­˜é¢„è­¦</text>
                </view>
                <view class="stats-item">
                    <text class="stats-number">{{totalPages}}</text>
                    <text class="stats-label">æ€»é¡µæ•°</text>
                </view>
            </view>

            <!-- åº“å­˜è¡¨æ ¼ -->
            <view class="inventory-table">
                <view class="table-header">
                    <view class="header-cell name">å•†å“åç§°</view>
                    <view class="header-cell store">åº—å</view>
                    <view class="header-cell quantity">åº“å­˜é‡</view>
                    <view class="header-cell unit">å•ä½</view>
                    <view class="header-cell actions">æ“ä½œ</view>
                </view>

                <view class="table-body">
                    <view class="table-row {{item.isLowStock ? 'low-stock' : ''}}" wx:for="{{inventoryList}}"
                        wx:key="id" bindtap="showDetailModal" data-id="{{item.id}}">
                        <view class="table-cell name">
                            <view class="product-info">
                                <text class="product-name">{{item.name}}</text>
                                <text class="product-category">{{item.category}}</text>
                            </view>
                        </view>

                        <view class="table-cell store">
                            <text class="store-text">{{item.store}}</text>
                        </view>

                        <view class="table-cell quantity">
                            <view class="quantity-display">
                                <text class="quantity-number">{{item.quantity}}</text>
                                <view class="stock-status" wx:if="{{item.isLowStock>=item.quantity}}">
                                    <text class="warning-icon">âš ï¸</text>
                                </view>
                            </view>
                        </view>

                        <view class="table-cell unit">
                            <text class="unit-text">{{item.unit}}</text>
                        </view>

                        <view class="table-cell actions">
                            <button class="action-btn edit" size="mini" data-id="{{item.id}}" catchtap="editInventory">
                                <text class="action-icon">âœï¸</text>
                            </button>
                            <button class="action-btn delete" size="mini" data-id="{{item.id}}"
                                catchtap="deleteInventory">
                                <text class="action-icon">ğŸ—‘ï¸</text>
                            </button>
                        </view>
                    </view>
                </view>
            </view>

            <!-- åˆ†é¡µåŠ è½½æç¤º -->
            <view class="load-more-container">
                <view wx:if="{{isLoading}}" class="loading-more">
                    <view class="loading-spinner"></view>
                    <text class="loading-text">æ­£åœ¨åŠ è½½æ›´å¤š...</text>
                </view>

                <view wx:if="{{!hasMore && totalCount > 0}}" class="no-more-data">
                    <text class="no-more-text">å·²åŠ è½½å…¨éƒ¨å•†å“</text>
                </view>

                <view wx:if="{{hasMore && !isLoading}}" class="load-more-tip">
                    <text class="load-more-text">ä¸Šæ‹‰åŠ è½½æ›´å¤š</text>
                </view>
            </view>
        </view>

        <!-- ç©ºçŠ¶æ€ -->
        <view wx:else class="empty-state">
            <view class="empty-icon">ğŸ“¦</view>
            <text class="empty-text" wx:if="{{searchKeyword}}">æœªæ‰¾åˆ°åŒ¹é…çš„å•†å“</text>
            <text class="empty-text" wx:else>æš‚æ— åº“å­˜ä¿¡æ¯</text>
            <button class="btn-primary" bindtap="showAddModal">æ–°å¢å•†å“</button>
        </view>
    </view>

    <!-- æ–°å¢å•†å“æŒ‰é’® -->
    <view class="add-btn-container" wx:if="{{inventoryList.length > 0}}">
        <button class="add-btn" bindtap="showAddModal">
            <text class="add-icon">+</text>
            <text class="add-text">æ–°å¢åº“å­˜</text>
        </button>
    </view>

    <!-- è¯¦æƒ…å¼¹çª— -->
    <view class="detail-modal" wx:if="{{showDetailModal}}">
        <view class="modal-mask" bindtap="hideDetailModal"></view>
        <view class="modal-content">
            <view class="modal-header">
                <text class="modal-title">åº“å­˜è¯¦æƒ…</text>
                <text class="close-btn" bindtap="hideDetailModal">Ã—</text>
            </view>

            <scroll-view class="modal-body" scroll-y>
                <!-- åŸºæœ¬ä¿¡æ¯ -->
                <view class="detail-section">
                    <view class="section-title">åŸºæœ¬ä¿¡æ¯</view>
                    <view class="detail-row">
                        <text class="detail-label">å•†å“åç§°ï¼š</text>
                        <text class="detail-value">{{currentDetail.name}}</text>
                    </view>
                    <view class="detail-row">
                        <text class="detail-label">å•†å“åˆ†ç±»ï¼š</text>
                        <text class="detail-value">{{currentDetail.category}}</text>
                    </view>
                    <view class="detail-row">
                        <text class="detail-label">æ‰€åœ¨åº—é“ºï¼š</text>
                        <text class="detail-value">{{currentDetail.store}}</text>
                    </view>
                    <view class="detail-row">
                        <text class="detail-label">å½“å‰åº“å­˜ï¼š</text>
                        <view class="stock-info">
                            <text class="stock-quantity">{{currentDetail.quantity}}</text>
                            <text class="stock-unit">{{currentDetail.unit}}</text>
                        </view>
                    </view>
                    <view class="detail-row">
                        <text class="detail-label">åº“å­˜é¢„è­¦ï¼š</text>
                        <view class="stock-warning 
                        {{currentDetail.isLowStock>=currentDetail.quantity ? 'warning' : 'normal'}}">
                            <text>{{currentDetail.isLowStock>=currentDetail.quantity ? 'ä½äºé¢„è­¦çº¿' : 'æ­£å¸¸'}}</text>
                        </view>
                    </view>
                </view>

                <!-- å¤‡æ³¨ä¿¡æ¯ -->
                <view class="detail-section" wx:if="{{currentDetail.notes}}">
                    <view class="section-title">å¤‡æ³¨ä¿¡æ¯</view>
                    <view class="detail-row full-width">
                        <text class="detail-value">{{currentDetail.notes}}</text>
                    </view>
                </view>
                <!-- å…¥åº“ä¿¡æ¯ -->
                <view class="detail-section" wx:if="{{currentDetail.lastIn}}">
                    <view class="section-header">
                        <text class="section-title">æœ€åå…¥åº“</text>
                        <button class="btn-record all-in" bindtap="gotoInRecords">å…¨éƒ¨å…¥åº“</button>
                    </view>
                    <view class="detail-row">
                        <text class="detail-label">å…¥åº“æ—¶é—´ï¼š</text>
                        <text class="detail-value">{{currentDetail.lastIn.rksj || 'æ— è®°å½•'}}</text>
                    </view>
                    <view class="detail-row">
                        <text class="detail-label">å…¥åº“äººï¼š</text>
                        <text class="detail-value">{{currentDetail.lastIn.jjygb.nickname || 'æœªçŸ¥'}}</text>
                    </view>
                    <view class="detail-row">
                        <text class="detail-label">å…¥åº“æ•°é‡ï¼š</text>
                        <text class="detail-value">{{currentDetail.lastIn.rksl || 0}} {{currentDetail.unit}}</text>
                    </view>
                </view>


                <!-- å‡ºåº“ä¿¡æ¯ -->
                <view class="detail-section" wx:if="{{currentDetail.lastOut}}">
                    <view class="section-header">
                        <text class="section-title">æœ€åå‡ºåº“</text>
                        <button class="btn-record all-out" bindtap="gotoOutRecords">å…¨éƒ¨å‡ºåº“</button>
                    </view>
                    <view class="detail-row">
                        <text class="detail-label">å‡ºåº“æ—¶é—´ï¼š</text>
                        <text class="detail-value">{{currentDetail.lastOut.cksj || 'æ— è®°å½•'}}</text>
                    </view>
                    <view class="detail-row">
                        <text class="detail-label">å‡ºåº“äººï¼š</text>
                        <text class="detail-value">{{currentDetail.lastOut.jjygb.nickname || 'æœªçŸ¥'}}</text>
                    </view>
                    <view class="detail-row">
                        <text class="detail-label">å‡ºåº“æ•°é‡ï¼š</text>
                        <text class="detail-value">{{currentDetail.lastOut.cksl || 0}} {{currentDetail.unit}}</text>
                    </view>
                    <view class="detail-row">
                        <text class="detail-label">å‡ºåº“ç”¨é€”ï¼š</text>
                        <text class="detail-value">{{currentDetail.lastOut.ckyt || 'æœªæŒ‡å®š'}}</text>
                    </view>
                </view>
                <!-- å¦‚æœéƒ½æ²¡æœ‰è®°å½•ï¼Œæ˜¾ç¤ºæç¤º -->
                <view class="detail-section"
                    wx:if="{{!currentDetail.lastIn && !currentDetail.lastOut && currentDetail.lastIn !== null}}">
                    <view class="section-title">å‡ºå…¥åº“è®°å½•</view>
                    <view class="empty-record">
                        <text class="empty-record-text">æš‚æ— å‡ºå…¥åº“è®°å½•</text>
                    </view>
                </view>


            </scroll-view>

            <!-- æ“ä½œæŒ‰é’® -->
            <view class="modal-footer">
                <button class="btn-in" bindtap="showInModal">å…¥åº“</button>
                <button class="btn-out" bindtap="showOutModal">å‡ºåº“</button>
            </view>
        </view>
    </view>

    <!-- æ–°å¢å•†å“å¼¹çª—ç»„ä»¶ -->
    <add-inventory-modal id="addInventoryModal" bind:confirm="handleAddInventory" bind:cancel="hideAddModal" />

    <!-- å…¥åº“/å‡ºåº“å¼¹çª—ç»„ä»¶ -->
    <in-out-modal id="inOutModal" 
        type="{{inOutType}}" 
        inventory-id="{{currentDetail.id}}"
        inventory-name="{{currentDetail.name}}"
        current-quantity="{{currentDetail.quantity}}" 
        unit="{{currentDetail.unit}}" bind:confirm="handleInOutConfirm"
        bind:cancel="hideInOutModal" />
</view>